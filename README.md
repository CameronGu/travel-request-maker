# Travel-Request Platform Rebuild

This repo contains the **Travel-Request Platform Rebuild** ‚Äî a Next.js and Supabase-based application to manage enterprise travel requests.  
It consolidates all previous systems into a modern, maintainable, and well-documented platform.

---

## Purpose

- Simplify travel request workflows for **coordinators, bookers, billing staff, and client admins**.
- Use a **dynamic form engine** to reduce redundancy and support complex service needs.
- Ensure **data security** via JWE links and Supabase-based data handling.
- Serve as the single source of truth for travel request lifecycle.

---

## Structure

- **`docs/latest/`**:  
  The canonical location for all project specs.  
  - `prd.md` ‚Äì Product Requirements Document  
  - `form-spec.md` ‚Äì Form fields and validation logic  
  - `roles-permissions.md` ‚Äì Access control model  
  - `legacy-mapping.md` ‚Äì Legacy system to new mapping  
  - `admin-ui-wireframes.md` ‚Äì Wireframes and UI hints  
  - `jwe-link-spec.md` ‚Äì Secure link sharing format

- **`src/`**:  
  The Next.js app, including React components, Supabase hooks, and UI logic.

- **`.env.example` / `.env.local`**:  
  Environment variables for local development.

- **`tasks.json`**:  
  Tasks file generated by **TaskMaster AI** ‚Äî always based on current PRD + supporting specs.

---

## Setup & Dev Workflow

1Ô∏è‚É£ **Install dependencies**  
```bash
npm install
````

2Ô∏è‚É£ **Create local environment**

```bash
cp .env.example .env.local
```

Fill in with Supabase project credentials:

```
NEXT_PUBLIC_SUPABASE_URL=https://your-supabase-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-supabase-anon-key
```

3Ô∏è‚É£ **Run locally**

```bash
npm run dev
```

4Ô∏è‚É£ **(Re)generate tasks for Cursor**

```bash
npm run parse-prd
```

---

## üé® Theming

- Design tokens are managed in `styles/tokens.ts`.  
- Runtime CSS variables for themes are in `styles/theme.css`.  
- To add a new theme from tweakcn, run:

  ```bash
  npx shadcn@latest add https://tweakcn.com/r/themes/claymorphism.json
  ```

* Toggle themes using `next-themes`:

  ```tsx
  import { useTheme } from "next-themes";
  const { setTheme } = useTheme();
  setTheme("dark"); // or "light", "claymorphism", etc.
  ```

* See `layout.tsx` for theme provider setup.

---

## Branch & Release Strategy

* **Active dev branch**: `next-migration`
* **Stable branch**: `main` (protected, only merge via PRs)

No direct pushes to `main` ‚Äî enforced via GitHub rules (public repos only).

---

## Notes for Me

* **TaskMaster parse command:**

  ```bash
  task-master parse-prd prd.md -k docs/latest/ -o tasks.json
  ```

  (wrapped as `npm run parse-prd`)

* **Supabase & Vercel setup**:

  * Supabase: project created and linked
  * Vercel: linked, but can stay local until MVP ready

* **Environment variables checklist:**

  * `NEXT_PUBLIC_SUPABASE_URL`
  * `NEXT_PUBLIC_SUPABASE_ANON_KEY`
  * (Optional) `NEXT_PUBLIC_JWE_KEY` for link encryption, if using

---

## Lint & Tests

* **Lint:**

  ```bash
  npm run lint
  ```

* **Tests:**

  ```bash
  npm run test
  ```

---

## Next Steps (MVP)

* Complete DynamicForm Engine
* Finish admin views (based on `admin-ui-wireframes.md`)
* Implement Supabase role logic from `roles-permissions.md`
* Integrate secure JWE links for link-based approval flows

---

## Misc

* **Audience:** Me / internal dev team only
* **Docs:** stored in `docs/latest/`
* **AI tools:** TaskMaster + Cursor ready to generate + execute tasks

---

## Development vs. Production Safeguards

**Hardcoded User in Middleware:**
- For local development, the middleware uses a hardcoded user (`app_att_admin`) to simplify RBAC testing.
- This logic is guarded by `process.env.NODE_ENV === 'development'`.
- **Before deploying to production:** Remove or disable the hardcoded user logic. In production, the middleware always uses the real Supabase session.

**Debug Page with Service Role Key:**
- The debug page (`/debug`) uses the Supabase service role key to bypass RLS and view all data for local/server-only debugging.
- This is only enabled when `NODE_ENV === 'development'` and is automatically disabled in production.
- **Never expose the service role key to client-side code or enable this page in production.**

**General Guidance:**
- Always check for and remove any dev-only logic before deploying.
- The service role key must remain secret and server-only.
- See code comments in `src/middleware.ts`, `src/app/debug/page.tsx`, and `src/lib/supabase/server.ts` for more details.

---

## Magic Link API Endpoint

A new API endpoint is available for generating and sending Supabase magic links:

- **Endpoint:** `POST /api/magic-link`
- **Payload:**
  - `email` (string, required): Target email address
  - `client_id` (string, required): Client identifier
  - `role`, `expires_at`, `traveler_ids`, `meta` (optional): Additional metadata for tracking

**How it works:**
- Validates input
- Inserts a row into the `links` table for tracking and RLS
- Calls Supabase's `inviteUserByEmail` to send the magic link
- Returns a success or error response

### Automated Testing
- Automated tests are provided in `src/app/api/magic-link/route.test.ts` and cover all major cases (success, input validation, error handling).
- **Note:** Due to Vitest/Next.js module cache limitations, error-case tests may not trigger as expected. The API implementation is robust, but dynamic mocking with `vi.doMock` and ESM imports can fail to override the cached module. For full confidence, manually test error cases in a staging environment.

### Manual Testing
- Use a tool like Postman or curl to POST to `/api/magic-link` with valid and invalid payloads.
- Check the Supabase dashboard for new link rows and email logs.
- Confirm the recipient receives a working magic link email.

---